<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mapa de Mesas — Invitación</title>
<style>
:root {
  --bg1: #fff0f6;
  --bg2: #ffe6f0;
  --accent: #ff8ab3;
  --accent-dark: #ff6f9c;
  --text: #4a2431;
  --muted: #7a4b5f;
}
html, body {margin:0; padding:0; height:100%; font-family:Inter, system-ui, sans-serif;}
body {background: linear-gradient(180deg, var(--bg1), var(--bg2)); display:flex; justify-content:center; align-items:flex-start; padding:20px;}
.page {width:100%; max-width:1156px; margin:0 auto;}
header {margin-bottom:16px; display:flex; justify-content:space-between; flex-wrap:wrap;}
header h1 {margin:0; font-size:1.25rem; color:var(--text);}
.map-card {background: rgba(255,255,255,0.92); border-radius:14px; padding:12px; box-shadow:0 10px 30px rgba(148,77,108,0.08); display:flex; flex-direction:column; gap:10px;}
.svg-wrap {width:100%; max-width:1056px; margin:0 auto; position:relative; border-radius:10px; overflow:hidden; background: linear-gradient(180deg, rgba(255,250,253,0.9), rgba(255,245,249,0.95));}
object#svgMap {width:100%; height:auto; display:block; min-height:360px; border:none; background:transparent;}
.controls {display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px;}
.mensaje {background:white; padding:8px 12px; border-radius:10px; box-shadow:0 6px 18px rgba(115,70,95,0.04); font-size:0.95rem;}
.mensaje.warn {border-left:4px solid #ffd7e6;}
.mensaje.error {border-left:4px solid #f1a1c9; color:#6a2b3f;}
.btn {background: linear-gradient(180deg, var(--accent), var(--accent-dark)); color:white; border:none; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600;}
.btn.ghost {background:transparent; color:var(--muted); border:1px solid rgba(120,70,90,0.06);}
@media(max-width:640px){header h1{font-size:1.05rem;}}
</style>
</head>
<body>
<div class="page">
  <header>
    <h1>Mapa de Mesas — Invitación</h1>
    <div></div>
  </header>
  <main class="map-card" role="main">
    <div class="controls">
      <div class="left"><div id="status" class="mensaje">Cargando mapa…</div></div>
      <div class="actions">
        <button id="copyLinkBtn" class="btn ghost" title="Copiar enlace">Copiar enlace</button>
        <button id="reloadBtn" class="btn ghost" title="Recargar">Recargar</button>
      </div>
    </div>
    <div class="svg-wrap" aria-hidden="false">
      <object id="svgMap" data="mapa.svg" type="image/svg+xml" aria-label="Mapa de mesas"></object>
    </div>
  </main>
</div>

<script>
(async function(){
const SVG_NS='http://www.w3.org/2000/svg';
const statusEl=document.getElementById('status');
const svgObj=document.getElementById('svgMap');
const copyBtn=document.getElementById('copyLinkBtn');
const reloadBtn=document.getElementById('reloadBtn');

const params=new URLSearchParams(location.search);
const codigoParam=params.get('codigo');
const debugOn=params.get('debug')==='1';

function setStatus(text,kind=''){statusEl.textContent=text; statusEl.className='mensaje'+(kind?' '+kind:'');}

// Cargar mesas.json
let mesas=[];
async function loadMesas(){
  try{
    const res=await fetch('mesas.json',{cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data=await res.json();
    mesas=Array.isArray(data)?data:(Array.isArray(data.mesas)?data.mesas:[]);
    if(!mesas.length) throw new Error('mesas.json vacío');
  }catch(e){console.error(e); setStatus('Error cargando mesas.json','error'); mesas=[];}
}

// Google Sheets
const spreadsheetId = "1LKsB3nXQ8NqosmyuoiLTRxUrrQzsXAnf2hVlIxoiYQI";
const apiKey = "AIzaSyC916C1gjId46ClbCpxNaLRkPITQVKkF5E";
let invitados=[];

function normalizar(texto){ return texto?texto.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase():""; }

async function cargarInvitados(){
  const range="Invitados!A2:G";
  const url=`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}?key=${apiKey}`;
  try{
    const res=await fetch(url);
    if(!res.ok) throw new Error("Error HTTP "+res.status);
    const data=await res.json();
    if(data.values){
      invitados=data.values.map(row=>({codigo:row[0],nombre:row[1],mesa:row[5]}));
    }
  }catch(e){console.error("Error cargando invitados",e);}
}

// SVG indicator
let svgDoc=null, svgRoot=null;
const svgInnerStyles=`
  #indicator {
    fill: rgba(255,138,179,0.18);
    stroke: #ff8ab3;
    stroke-width: 6;
    filter: drop-shadow(0 8px 22px rgba(185,95,135,0.17));
    transform-box: fill-box;
    transform-origin: center center;
    animation: pulse 1200ms ease-in-out infinite;
    vector-effect: non-scaling-stroke;
  }
  #indicator-label {
    font-family: Inter, system-ui, sans-serif;
    font-size: 18px;
    font-weight:700;
    fill:#4a2431;
    text-anchor:middle;
    pointer-events:none;
  }
  @keyframes pulse {0%{transform:scale(1);opacity:1}50%{transform:scale(1.25);opacity:0.48}100%{transform:scale(1);opacity:1}}
`;
function ensureIndicator(){
  if(!svgDoc||!svgRoot) return null;
  if(svgDoc.getElementById('indicator')) return svgDoc.getElementById('indicator');
  if(!svgDoc.getElementById('__injected_style')){
    const styleEl=svgDoc.createElementNS(SVG_NS,'style');
    styleEl.id='__injected_style'; styleEl.textContent=svgInnerStyles;
    svgRoot.appendChild(styleEl);
  }
  const g=svgDoc.createElementNS(SVG_NS,'g'); g.id='indicator-group'; g.setAttribute('aria-hidden','false');
  const circle=svgDoc.createElementNS(SVG_NS,'circle'); circle.id='indicator'; circle.setAttribute('cx',0); circle.setAttribute('cy',0); circle.setAttribute('r',100);
  const label=svgDoc.createElementNS(SVG_NS,'text'); label.id='indicator-label'; label.setAttribute('x',0); label.setAttribute('y',-120); label.textContent='';
  g.appendChild(circle); g.appendChild(label);
  svgRoot.appendChild(g);
  return circle;
}

function updateIndicator(inv){
  const mesaObj = mesas.find(m=>m.numero==inv.mesa||m.mesa==inv.mesa||m.id==inv.mesa);
  if(!mesaObj){ setStatus(`Mesa ${inv.mesa} no encontrada en mesas.json`,'error'); return; }
  const ind=ensureIndicator(); if(!ind) return;
  const label=svgDoc.getElementById('indicator-label');
  const cx=Number(mesaObj.x), cy=Number(mesaObj.y), r=(mesaObj.r?Number(mesaObj.r):100);
  ind.setAttribute('cx',cx); ind.setAttribute('cy',cy); ind.setAttribute('r',r);
  if(label){ label.textContent=`${inv.nombre} — Mesa ${inv.mesa}`; label.setAttribute('x',cx); label.setAttribute('y',cy-r-18); }
  setStatus(`Invitado: ${inv.nombre} — Mesa ${inv.mesa}`);
}

// Load everything
async function init(){
  await loadMesas();
  await cargarInvitados();
  svgObj.addEventListener('load',()=>{
    svgDoc=svgObj.contentDocument;
    svgRoot=svgDoc.documentElement;
    if(!codigoParam){ setStatus("No se proporcionó código",'warn'); return; }
    const inv=invitados.find(i=>i.codigo===codigoParam);
    if(!inv){ setStatus("Código no válido o invitado no encontrado",'error'); return; }
    updateIndicator(inv);
  });
}

init();

// Buttons
copyBtn.addEventListener('click',()=>{navigator.clipboard.writeText(location.href).then(()=>alert("Enlace copiado!"));});
reloadBtn.addEventListener('click',()=>location.reload());

})();
</script>
</body>
</html>
