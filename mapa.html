<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mapa de mesas ‚Äî Invitaci√≥n</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      /* Paleta de colores rosa pastel */
      --bg-1: #fff6f9;
      --bg-2: #fff0f6;
      --card: rgba(255,255,255,0.96);
      --accent: #ff8ab3;
      --accent-2: #ff6f9c;
      --muted: #7a5264;
      --muted-2: #a87691;
      --success: #e88fb3;
      --glass: rgba(255,255,255,0.7);
      --shadow-lg: 0 14px 40px rgba(150,80,115,0.08);
      --shadow-sm: 0 6px 18px rgba(120,70,100,0.06);
      --radius: 14px;
      --max-width: 1150px;
      --focus: 3px solid rgba(255,138,179,0.22);
    }

    /* Estilos base */
    html, body {
      height: 100%;
      margin: 0;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      background: linear-gradient(180deg, var(--bg-1), var(--bg-2));
      color: #3b2130;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .page {
      max-width: var(--max-width);
      margin: 28px auto;
      padding: 18px;
    }

    /* Header */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    .brand {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .logo {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      box-shadow: var(--shadow-sm);
      font-size: 18px;
    }

    header h1 {
      margin: 0;
      font-size: 1.15rem;
      letter-spacing: 0.2px;
      font-weight: 600;
      color: #4a2431;
    }

    header p {
      margin: 0;
      color: var(--muted);
      font-size: 0.95rem;
    }

    /* Layout principal */
    .grid {
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 14px;
    }

    @media (max-width: 980px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    /* Tarjeta del mapa */
    .map-card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow-lg);
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 420px;
    }

    /* Controles */
    .controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .status {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .status .bubble {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      border-radius: 12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.94));
      box-shadow: var(--shadow-sm);
      color: var(--muted);
      font-weight: 600;
      font-size: 0.95rem;
    }

    .status .bubble.error {
      border-left: 4px solid #f1a1c9;
      color: #6a2b3f;
    }

    .status .bubble.warn {
      border-left: 4px solid #ffd7e6;
      color: var(--muted-2);
    }

    .status .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 6px 14px rgba(255,138,179,0.12);
    }

    .actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    /* Botones */
    .btn {
      border: none;
      padding: 10px 14px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 700;
      font-size: 0.95rem;
      transition: transform .12s ease, box-shadow .12s ease;
      background: linear-gradient(180deg, var(--card), rgba(255,250,252,0.95));
      box-shadow: var(--shadow-sm);
      color: var(--muted);
      border: 1px solid rgba(140,90,110,0.04);
    }

    .btn.primary {
      background: linear-gradient(180deg, var(--accent), var(--accent-2));
      color: white;
      box-shadow: 0 6px 22px rgba(220,95,140,0.14);
    }

    .btn.ghost {
      background: transparent;
      color: var(--muted);
      border: 1px dashed rgba(140,90,110,0.06);
    }

    .btn:hover {
      transform: translateY(-2px);
    }

    .btn:focus {
      outline: var(--focus);
      outline-offset: 3px;
    }

    /* Contenedor SVG */
    .svg-wrap {
      width: 100%;
      border-radius: 10px;
      overflow: hidden;
      background: linear-gradient(180deg, rgba(255,250,253,0.95), rgba(255,246,249,0.98));
      border: 1px solid rgba(200,160,180,0.06);
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 300px;
    }

    object#svgMap {
      width: 100%;
      height: auto;
      display: block;
      min-height: 300px;
    }

    /* Panel lateral */
    .panel {
      background: linear-gradient(180deg, rgba(255,250,253,0.98), rgba(255,246,249,0.99));
      border-radius: 12px;
      padding: 16px;
      box-shadow: var(--shadow-sm);
      border: 1px solid rgba(200,160,180,0.04);
      height: 100%;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .panel .title {
      font-weight: 700;
      color: #4a2431;
      font-size: 0.95rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    /* Tarjeta de invitado */
    .guest-card {
      background: linear-gradient(180deg, #ffffff, rgba(255,248,250,0.95));
      border-radius: 12px;
      padding: 14px;
      box-shadow: 0 8px 28px rgba(160,90,120,0.06);
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: flex-start;
    }

    .guest-name {
      font-size: 1.1rem;
      font-weight: 700;
      color: #4a2431;
    }

    .guest-mesa {
      font-size: 2rem;
      font-weight: 800;
      color: var(--accent);
      letter-spacing: 1px;
    }

    .guest-info {
      color: var(--muted);
      font-size: 0.95rem;
    }

    .hint {
      font-size: 0.86rem;
      color: var(--muted);
    }

    footer {
      margin-top: 18px;
      text-align: center;
      color: var(--muted);
      font-size: 0.88rem;
    }

    /* Mejoras para m√≥viles */
    @media (max-width: 640px) {
      .page {
        padding: 12px;
        margin: 12px auto;
      }

      .brand .logo {
        width: 40px;
        height: 40px;
        font-size: 16px;
      }

      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      .controls {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      .actions {
        width: 100%;
        justify-content: space-between;
      }

      .btn {
        flex: 1;
        text-align: center;
        padding: 12px 16px;
      }

      .panel {
        order: 2;
      }

      .svg-wrap {
        order: 1;
        min-height: 250px;
      }

      .guest-mesa {
        font-size: 1.6rem;
      }

      .guest-name {
        font-size: 1rem;
      }
    }

    @media (max-width: 480px) {
      .grid {
        gap: 10px;
      }

      .map-card {
        padding: 10px;
      }

      .panel {
        padding: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="brand" aria-hidden="false">
        <div class="logo" aria-hidden="true">XV</div>
        <div>
          <h1>Mapa de mesas</h1>
          <p style="margin:4px 0 0;color:var(--muted);font-size:0.95rem">Escanea y ver√°s tu mesa resaltada</p>
        </div>
      </div>

      <div class="status" aria-live="polite" aria-atomic="true">
        <div id="statusBubble" class="bubble">Iniciando‚Ä¶</div>
      </div>
    </header>

    <div class="grid" role="region" aria-label="Mapa y detalles">
      <section class="map-card" aria-label="Mapa">
        <div class="controls" role="toolbar" aria-label="Controles de mapa">
          <div style="display:flex;align-items:center;gap:12px;">
            <div class="dot" aria-hidden="true"></div>
            <div style="color:var(--muted);font-weight:600">Indicador: circulo rosa</div>
          </div>

          <div class="actions">
            <button id="copyLinkBtn" class="btn ghost" title="Copiar enlace actual">Copiar enlace</button>
            <button id="reloadBtn" class="btn" title="Recargar">Recargar</button>
          </div>
        </div>

        <div class="svg-wrap" aria-hidden="false">
          <object id="svgMap" data="mapa.svg" type="image/svg+xml" aria-label="Mapa de mesas"></object>
        </div>
      </section>

      <aside class="panel" aria-label="Informaci√≥n del invitado">
        <div class="title">
          <span>Invitado</span>
          <small style="color:var(--muted)">Detalles</small>
        </div>

        <div id="guestCard" class="guest-card" aria-live="polite">
          <div class="guest-name" id="guestName">‚Äî</div>
          <div class="guest-mesa" id="guestMesa">‚Äî</div>
          <div class="guest-info" id="guestInfo">Introduce tu c√≥digo en la URL: <code>?codigo=TU_CODIGO</code></div>
        </div>

        <div style="display:flex;gap:8px;">
          <button id="shareBtn" class="btn primary" title="Compartir enlace con c√≥digo">Compartir enlace</button>
          <button id="helpBtn" class="btn ghost" title="Ayuda">Ayuda</button>
        </div>

        <div class="hint" style="margin-top:auto">
            Gracias por su presencia üòÑ
        </div>
      </aside>
    </div>

    <footer>
      <small> </small>
    </footer>
  </div>

<script>
/**
 * Mapa de Mesas - Aplicaci√≥n para visualizar ubicaci√≥n de invitados
 *
 * Funcionalidades:
 * - Carga datos de mesas desde mesas.json
 * - Obtiene lista de invitados desde Google Sheets
 * - Muestra ubicaci√≥n en mapa SVG seg√∫n c√≥digo de invitado
 * - Interacci√≥n con mapa para obtener informaci√≥n de mesas
 *
 * @author [Tu nombre]
 * @version 2.0
 */

(function(){
  'use strict';

  // CONSTANTES Y CONFIGURACI√ìN
  const SVG_NS = 'http://www.w3.org/2000/svg';
  const CONFIG = {
    spreadsheetId: "1LKsB3nXQ8NqosmyuoiLTRxUrrQzsXAnf2hVlIxoiYQI",
    apiKey: "AIzaSyC916C1gjId46ClbCpxNaLRkPITQVKkF5E",
    sheetsRange: "Invitados!A2:I"
  };

  // ELEMENTOS DEL DOM
  const elements = {
    statusBubble: document.getElementById('statusBubble'),
    svgObj: document.getElementById('svgMap'),
    copyBtn: document.getElementById('copyLinkBtn'),
    reloadBtn: document.getElementById('reloadBtn'),
    shareBtn: document.getElementById('shareBtn'),
    helpBtn: document.getElementById('helpBtn'),
    guestNameEl: document.getElementById('guestName'),
    guestMesaEl: document.getElementById('guestMesa'),
    guestInfoEl: document.getElementById('guestInfo')
  };

  // PAR√ÅMETROS DE URL
  const params = new URLSearchParams(location.search);
  const codigoParamRaw = params.get('codigo');
  const debugOn = params.get('debug') === '1';

  // ESTADO DE LA APLICACI√ìN
  const state = {
    mesas: [],
    invitados: [],
    svgDoc: null,
    svgRoot: null
  };

  /**
   * Actualiza el estado visual del sistema
   * @param {string} text - Texto a mostrar
   * @param {string} kind - Tipo de estado (error, warn, etc.)
   */
  function setStatus(text, kind = '') {
    elements.statusBubble.textContent = text;
    elements.statusBubble.className = 'bubble' + (kind ? ' ' + kind : '');
  }

  /**
   * Actualiza la informaci√≥n del invitado en el panel lateral
   * @param {string} name - Nombre del invitado
   * @param {string|number} mesa - N√∫mero de mesa
   * @param {string} msg - Mensaje informativo
   */
  function setGuest(name, mesa, msg) {
    elements.guestNameEl.textContent = name || '‚Äî';
    elements.guestMesaEl.textContent = mesa ? String(mesa).padStart(2, '0') : '‚Äî';
    elements.guestInfoEl.textContent = msg || '';
  }

  /**
   * Normaliza texto para comparaci√≥n (elimina acentos y convierte a min√∫sculas)
   * @param {string} texto - Texto a normalizar
   * @returns {string} Texto normalizado
   */
  function normalizar(texto) {
    return texto ? String(texto).normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase() : "";
  }

  /**
   * Limpia y asegura formato de cadena
   * @param {*} x - Valor a convertir
   * @returns {string} Cadena limpia
   */
  function trimStr(x) {
    return x === undefined || x === null ? '' : String(x).trim();
  }

  /**
   * Carga datos de mesas desde archivo JSON
   * @returns {Promise<boolean>} √âxito de la operaci√≥n
   */
  async function loadMesas() {
    try {
      const res = await fetch('mesas.json', { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status);

      const data = await res.json();
      state.mesas = Array.isArray(data) ? data : (Array.isArray(data.mesas) ? data.mesas : []);

      if (!state.mesas.length) throw new Error('mesas.json vac√≠o o con formato inesperado');

      return true;
    } catch (e) {
      console.error('Error cargando mesas.json', e);
      setStatus('Error cargando mesas.json ‚Äî revisa el archivo.', 'error');
      setGuest('‚Äî', null, 'No se pudo cargar la configuraci√≥n de mesas.');
      state.mesas = [];
      return false;
    }
  }

  /**
   * Carga lista de invitados desde Google Sheets
   * @returns {Promise<boolean>} √âxito de la operaci√≥n
   */
  async function cargarInvitados() {
    try {
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.spreadsheetId}/values/${CONFIG.sheetsRange}?key=${CONFIG.apiKey}`;
      const res = await fetch(url);

      if (!res.ok) throw new Error('HTTP ' + res.status);

      const data = await res.json();
      if (!data.values) {
        setStatus('No se encontraron registros en la hoja.', 'error');
        state.invitados = [];
        setGuest('‚Äî', null, 'No hay registros en la hoja de invitados.');
        return false;
      }

      // Remover headers si vienen
      const rows = data.values.slice(1);
      if (rows.length === 0) {
        setStatus('No se encontraron registros de invitados.', 'error');
        state.invitados = [];
        setGuest('‚Äî', null, 'Lista de invitados vac√≠a.');
        return false;
      }

      // Procesar filas de invitados
      state.invitados = rows.map(row => ({
        codigo: trimStr(row[0]),
        nombre: trimStr(row[1]),
        mesa: trimStr(row[8] || '')
      }));

      return true;
    } catch (e) {
      console.error('Error cargando invitados', e);
      setStatus('Error cargando lista de invitados (Google Sheets).', 'error');
      state.invitados = [];
      setGuest('‚Äî', null, 'No se pudo cargar la lista de invitados.');
      return false;
    }
  }

  /**
   * Busca invitado por c√≥digo o nombre
   * @param {string} codigo - C√≥digo o nombre del invitado
   * @returns {object|null} Datos del invitado o null
   */
  function findInvitadoByCodigo(codigo) {
    if (!codigo) return null;
    const key = normalizar(codigo);
    return state.invitados.find(inv =>
      normalizar(inv.codigo) === key || normalizar(inv.nombre) === key
    ) || null;
  }

  /**
   * Verifica si un objeto de mesa coincide con un valor de mesa
   * @param {object} mObj - Objeto de mesa
   * @param {string} mesaValue - Valor de mesa a comparar
   * @returns {boolean} True si coinciden
   */
  function mesaMatches(mObj, mesaValue) {
    if (!mObj) return false;

    const candidates = [
      mObj.numero, mObj.mesa, mObj.id, mObj.number, mObj.num
    ].filter(x => x !== undefined && x !== null);

    for (const c of candidates) {
      if (String(c) === String(mesaValue)) return true;

      const nc = parseInt(c, 10);
      const nv = parseInt(mesaValue, 10);
      if (!isNaN(nc) && !isNaN(nv) && nc === nv) return true;

      if (String(c).padStart(2, '0') === String(mesaValue).padStart(2, '0')) return true;
    }

    return false;
  }

  /**
   * Busca objeto de mesa por valor
   * @param {string} mesaValue - Valor de mesa
   * @returns {object|null} Objeto de mesa o null
   */
  function findMesaObj(mesaValue) {
    if (!state.mesas || !state.mesas.length) return null;
    return state.mesas.find(m => mesaMatches(m, mesaValue)) || null;
  }

  /**
   * Estilos CSS para elementos SVG inyectados
   */
  const svgInnerStyles = `
    #indicator {
      fill: rgba(255,138,179,0.18);
      stroke: #ff8ab3;
      stroke-width: 6;
      filter: drop-shadow(0 8px 22px rgba(185,95,135,0.17));
      transform-box: fill-box;
      transform-origin: center center;
      animation: pulse 1200ms ease-in-out infinite;
      vector-effect: non-scaling-stroke;
    }
    #indicator-label {
      font-family: Inter, system-ui, sans-serif;
      font-size: 16px;
      font-weight:700;
      fill:#4a2431;
      text-anchor:middle;
      pointer-events:none;
    }
    #indicator-label-bg {
      fill: #fff;
      stroke: rgba(120,60,90,0.06);
      rx: 8;
      ry: 8;
      opacity: 0.95;
    }
    @keyframes pulse {
      0% { transform: scale(1); opacity: 1 }
      50% { transform: scale(1.18); opacity: 0.6 }
      100% { transform: scale(1); opacity: 1 }
    }
    .debug-grid line { stroke: rgba(90,60,82,0.06); stroke-width:1; }
    .debug-label { font-size:10px; fill: rgba(60,40,60,0.45); }
  `;

  /**
   * Crea o recupera el indicador visual en el SVG
   * @returns {SVGElement|null} Elemento indicador o null
   */
  function ensureIndicator() {
    if (!state.svgDoc || !state.svgRoot) return null;

    const existing = state.svgDoc.getElementById('indicator');
    if (existing) return existing;

    // Inyectar estilos si no existen
    if (!state.svgDoc.getElementById('__injected_style')) {
      const styleEl = state.svgDoc.createElementNS(SVG_NS, 'style');
      styleEl.setAttribute('id', '__injected_style');
      styleEl.textContent = svgInnerStyles;
      state.svgRoot.appendChild(styleEl);
    }

    // Crear grupo de indicador
    const g = state.svgDoc.createElementNS(SVG_NS, 'g');
    g.setAttribute('id', 'indicator-group');
    g.setAttribute('aria-hidden', 'false');

    // Crear c√≠rculo indicador
    const circle = state.svgDoc.createElementNS(SVG_NS, 'circle');
    circle.setAttribute('id', 'indicator');
    circle.setAttribute('cx', 0);
    circle.setAttribute('cy', 0);
    circle.setAttribute('r', 100);

    // Crear fondo de etiqueta
    const labelBg = state.svgDoc.createElementNS(SVG_NS, 'rect');
    labelBg.setAttribute('id', 'indicator-label-bg');
    labelBg.setAttribute('width', '200');
    labelBg.setAttribute('height', '32');
    labelBg.setAttribute('x', '-100');
    labelBg.setAttribute('y', '-150');

    // Crear etiqueta de texto
    const label = state.svgDoc.createElementNS(SVG_NS, 'text');
    label.setAttribute('id', 'indicator-label');
    label.setAttribute('x', 0);
    label.setAttribute('y', -130);
    label.textContent = '';

    // Ensamblar elementos
    g.appendChild(circle);
    g.appendChild(labelBg);
    g.appendChild(label);
    state.svgRoot.appendChild(g);

    return circle;
  }

  /**
   * Actualiza el indicador para mostrar la ubicaci√≥n de un invitado
   * @param {object} inv - Datos del invitado
   * @returns {boolean} √âxito de la operaci√≥n
   */
  function updateIndicatorForInvitado(inv) {
    if (!state.svgDoc || !state.svgRoot) return false;

    const mesaVal = inv.mesa;
    const mesaObj = findMesaObj(mesaVal);

    if (!mesaObj) {
      setStatus(`Mesa ${mesaVal} no encontrada en mesas.json`, 'error');
      setGuest(inv.nombre || '‚Äî', null, `Mesa ${mesaVal} no encontrada`);
      return false;
    }

    const ind = ensureIndicator();
    if (!ind) return false;

    const label = state.svgDoc.getElementById('indicator-label');
    const labelBg = state.svgDoc.getElementById('indicator-label-bg');

    const cx = Number(mesaObj.x);
    const cy = Number(mesaObj.y);
    const r = (mesaObj.r !== undefined && !isNaN(Number(mesaObj.r))) ? Number(mesaObj.r) : 100;

    // Actualizar posici√≥n y tama√±o del indicador
    ind.setAttribute('cx', cx);
    ind.setAttribute('cy', cy);
    ind.setAttribute('r', r);

    // Actualizar etiqueta
    const displayMesa = String(mesaVal).padStart(2, '0');
    const text = `Mesa ${displayMesa}`;
    label.textContent = text;
    label.setAttribute('x', cx);
    label.setAttribute('y', cy - r - 16);

    // Ajustar tama√±o del fondo de etiqueta
    const approxCharWidth = 9;
    const padding = 18;
    const textWidth = Math.max(80, text.length * approxCharWidth);

    labelBg.setAttribute('width', String(textWidth + padding));
    labelBg.setAttribute('height', '32');
    labelBg.setAttribute('x', String(cx - (textWidth + padding) / 2));
    labelBg.setAttribute('y', String(cy - r - 34));

    // Actualizar UI
    setStatus(`Invitado: ${inv.nombre} ‚Äî Mesa ${displayMesa}`);
    setGuest(inv.nombre, displayMesa, `Mesa ${displayMesa} ‚Äî ¬°Disfruta la recepci√≥n!`);

    return true;
  }

  /**
   * Dibuja cuadr√≠cula de depuraci√≥n si est√° activado el modo debug
   */
  function drawDebug() {
    if (!debugOn || !state.svgDoc || !state.svgRoot) return;

    const prev = state.svgDoc.getElementById('debug-layer');
    if (prev) prev.remove();

    const g = state.svgDoc.createElementNS(SVG_NS, 'g');
    g.setAttribute('id', 'debug-layer');

    const viewBox = state.svgRoot.viewBox && state.svgRoot.viewBox.baseVal ?
      state.svgRoot.viewBox.baseVal : { width: 1056, height: 816 };

    const step = 48;

    // Dibujar l√≠neas verticales
    for (let x = 0; x <= viewBox.width; x += step) {
      const ln = state.svgDoc.createElementNS(SVG_NS, 'line');
      ln.setAttribute('x1', x);
      ln.setAttribute('y1', 0);
      ln.setAttribute('x2', x);
      ln.setAttribute('y2', viewBox.height);
      ln.setAttribute('class', 'debug-grid');
      g.appendChild(ln);
    }

    // Dibujar l√≠neas horizontales
    for (let y = 0; y <= viewBox.height; y += step) {
      const ln = state.svgDoc.createElementNS(SVG_NS, 'line');
      ln.setAttribute('x1', 0);
      ln.setAttribute('y1', y);
      ln.setAttribute('x2', viewBox.width);
      ln.setAttribute('y2', y);
      ln.setAttribute('class', 'debug-grid');
      g.appendChild(ln);
    }

    // Etiquetar mesas
    state.mesas.forEach(m => {
      const lbl = state.svgDoc.createElementNS(SVG_NS, 'text');
      lbl.setAttribute('x', Number(m.x) + 10);
      lbl.setAttribute('y', Number(m.y) - 10);
      lbl.setAttribute('class', 'debug-label');

      const n = m.numero ?? m.mesa ?? m.id ?? m.number ?? '?';
      lbl.textContent = `${String(n).padStart(2, '0')} (${m.x},${m.y})`;
      g.appendChild(lbl);
    });

    state.svgRoot.appendChild(g);
  }

  /**
   * Encuentra la mesa m√°s cercana a unas coordenadas SVG
   * @param {number} svgX - Coordenada X
   * @param {number} svgY - Coordenada Y
   * @param {number} threshold - Umbral de distancia m√°xima
   * @returns {object|null} Mesa m√°s cercana o null
   */
  function findClosestMesa(svgX, svgY, threshold = 140) {
    if (!state.mesas || !state.mesas.length) return null;

    let best = null;
    let bestDist = Infinity;

    state.mesas.forEach(m => {
      const dx = svgX - Number(m.x);
      const dy = svgY - Number(m.y);
      const d = Math.sqrt(dx * dx + dy * dy);

      if (d < bestDist) {
        bestDist = d;
        best = m;
      }
    });

    return (bestDist <= threshold) ? best : null;
  }

  /**
   * Configura interacciones con el SVG
   */
  function attachSvgInteractions() {
    if (!state.svgRoot) return;

    // Click para mostrar informaci√≥n de mesa
    state.svgRoot.addEventListener('click', (ev) => {
      try {
        const pt = state.svgRoot.createSVGPoint();
        pt.x = ev.clientX;
        pt.y = ev.clientY;

        const loc = pt.matrixTransform(state.svgRoot.getScreenCTM().inverse());
        const closest = findClosestMesa(loc.x, loc.y, 140);

        if (closest) {
          const fakeInv = {
            nombre: `Mesa ${closest.numero ?? closest.mesa ?? closest.id ?? '?'}`,
            mesa: closest.numero ?? closest.mesa ?? closest.id ?? (closest.number ?? closest.num)
          };
          updateIndicatorForInvitado(fakeInv);
        } else {
          setStatus('No se detect√≥ una mesa cercana al clic.', 'warn');
        }
      } catch (e) {
        console.error('Error en click SVG', e);
      }
    });

    // Doble click para copiar URL
    state.svgRoot.addEventListener('dblclick', () => {
      const url = location.href;
      navigator.clipboard?.writeText(url).then(() => setStatus('Enlace copiado al portapapeles.'))
        .catch(() => prompt('Copia esta URL:', url));
    });

    // Click derecho para informaci√≥n de coordenadas
    state.svgRoot.addEventListener('contextmenu', (ev) => {
      ev.preventDefault();
      const tgt = ev.target;

      if (tgt && tgt.id === 'indicator') {
        const cx = tgt.getAttribute('cx');
        const cy = tgt.getAttribute('cy');
        setStatus(`Indicador: (${cx}, ${cy})`);
      }
    });
  }

  /**
   * Inicializa la aplicaci√≥n
   */
  async function init() {
    setStatus('Cargando mesas y lista de invitados...');

    const okMesas = await loadMesas();
    const okInv = await cargarInvitados();

    if (!okMesas) return;

    if (!okInv) {
      setStatus('Lista de invitados no disponible. Si tienes c√≥digo, no funcionar√° la b√∫squeda.', 'warn');
    }

    /**
     * Maneja la carga del SVG
     */
    function onSvgLoaded() {
      try {
        state.svgDoc = elements.svgObj.contentDocument;

        if (!state.svgDoc) {
          setStatus('No se pudo acceder al SVG (problema de origen).', 'error');
          setGuest('‚Äî', null, 'Error cargando mapa.');
          return;
        }

        state.svgRoot = state.svgDoc.documentElement;
        drawDebug();

        // Procesar c√≥digo de invitado si est√° presente
        if (codigoParamRaw) {
          const invited = findInvitadoByCodigo(codigoParamRaw);

          if (!invited) {
            setStatus('C√≥digo no v√°lido o invitado no encontrado.', 'error');
            setGuest('‚Äî', null, 'C√≥digo no v√°lido o invitado no encontrado.');

            const old = state.svgDoc.getElementById('indicator-group');
            if (old) old.remove();

            return;
          }

          const ok = updateIndicatorForInvitado(invited);
          if (!ok) {
            const old = state.svgDoc.getElementById('indicator-group');
            if (old) old.remove();
          }
        } else {
          setStatus('No se especific√≥ c√≥digo (par√°metro ?codigo=...).', 'warn');
          setGuest('‚Äî', null, 'Introduce tu c√≥digo en la URL (?codigo=...)');
        }

        attachSvgInteractions();
      } catch (e) {
        console.error('Error al inicializar SVG', e);
        setStatus('Ocurri√≥ un error al inicializar el mapa.', 'error');
      }
    }

    // Configurar eventos del SVG
    elements.svgObj.addEventListener('load', onSvgLoaded);

    try {
      if (elements.svgObj.contentDocument && elements.svgObj.contentDocument.readyState === 'complete') {
        onSvgLoaded();
      }
    } catch (e) {
      console.warn('No se pudo verificar estado del SVG:', e);
    }
  }

  // CONFIGURACI√ìN DE EVENTOS DE BOTONES

  /**
   * Maneja la copia de enlace
   */
  elements.copyBtn.addEventListener('click', () => {
    const url = location.href;
    navigator.clipboard?.writeText(url).then(() => setStatus('URL copiada al portapapeles.'))
      .catch(() => prompt('Copia esta URL:', url));
  });

  /**
   * Maneja el compartir enlace
   */
  elements.shareBtn.addEventListener('click', () => {
    const url = location.href;

    if (navigator.share) {
      navigator.share({
        title: 'Mi mesa',
        text: 'Aqu√≠ mi ubicaci√≥n',
        url
      }).then(() => setStatus('Compartido con √©xito.'));
    } else {
      navigator.clipboard?.writeText(url).then(() => setStatus('Enlace copiado para compartir.'))
        .catch(() => prompt('Copia esta URL:', url));
    }
  });

  /**
   * Muestra ayuda al usuario
   */
  elements.helpBtn.addEventListener('click', () => {
    alert('Abre este enlace incluyendo tu c√≥digo: ?codigo=TU_CODIGO\nEjemplo: ?codigo=ABC123\nSi no aparece, revisa espacios o ceros a la izquierda.');
  });

  /**
   * Recarga datos y reinicializa
   */
  elements.reloadBtn.addEventListener('click', async () => {
    setStatus('Recargando datos...');

    await loadMesas();
    await cargarInvitados();

    try {
      if (elements.svgObj.contentDocument && elements.svgObj.contentDocument.documentElement) {
        state.svgDoc = elements.svgObj.contentDocument;
        state.svgRoot = state.svgDoc.documentElement;

        // Limpiar elementos anteriores
        const dbg = state.svgDoc.getElementById('debug-layer');
        if (dbg) dbg.remove();

        const old = state.svgDoc.getElementById('indicator-group');
        if (old) old.remove();

        drawDebug();

        // Reprocesar invitado si existe
        if (codigoParamRaw) {
          const invited = findInvitadoByCodigo(codigoParamRaw);

          if (!invited) {
            setStatus('C√≥digo no v√°lido o invitado no encontrado.', 'error');
            setGuest('‚Äî', null, 'C√≥digo no v√°lido');
            return;
          }

          const ok = updateIndicatorForInvitado(invited);
          if (!ok) {
            const old2 = state.svgDoc.getElementById('indicator-group');
            if (old2) old2.remove();
          }
        }
      }
    } catch (e) {
      console.error('Error al recargar', e);
      setStatus('Error al recargar SVG', 'error');
    }
  });

  // INICIALIZAR APLICACI√ìN
  init();
})();
</script>
</body>
</html>
