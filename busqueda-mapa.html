<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Encuentra tu mesa asignada</title>
  <style>
    * { box-sizing: border-box; }
    html,body { height: 100%; }
    body {
      background-color: #ffe6f0;
      font-family: Georgia, serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    .contenedor {
      background: white;
      padding: 30px 20px;
      border-radius: 20px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      border: 3px solid #f8c6d8;
      text-align: center;
      max-width: 400px;
      width: 100%;
      animation: fadeIn 0.35s ease;
    }
    @keyframes fadeIn {
      from { opacity:0; transform:scale(.98)}
      to { opacity:1; transform:none}
    }
    h2 { margin-top:0; font-size:1.5em; color:#cc2e72; }
    p { color:#5e3d4f; margin-bottom:8px; }
    .campo { position: relative; }
    input {
      padding:12px; font-size:1em; width:100%; border-radius:10px;
      border:1px solid #ccc; margin-bottom:10px;
    }
    input:focus { outline:3px solid rgba(204,46,114,0.18); }
    ul {
      list-style:none; padding:0; margin:5px 0 0; max-height:180px;
      overflow-y:auto; border:1px solid #ccc; border-radius:10px;
      background: white; display:none;
    }
    ul.mostrar { display:block; }
    li { padding:10px; cursor:pointer; transition:background-color .15s; }
    li:hover, li:focus { background-color: #f0cadd; outline:none; }
    li.seleccionado { background-color:#cc2e72; color:white; }
    button {
      padding:12px 20px; background:#cc2e72; color:white; border:none;
      border-radius:10px; font-size:1em; cursor:pointer; margin-top:15px; width:100%;
    }
    button[disabled] { opacity:.6; cursor:not-allowed; }
    #infoSeleccion {
      text-align:left; font-size:0.95em; color:#5e3d4f;
      margin-top:8px; display:none;
    }
    @media (max-width:480px) {
      body { padding:10px; align-items:flex-start; }
      .contenedor { padding:20px; margin-top:20px; }
    }
  </style>
</head>
<body>
  <div class="contenedor" role="region" aria-labelledby="titulo">
    <h2 id="titulo">üéÄ B√∫squeda de Mesa</h2>
    <p>Escribe tu nombre para buscar tu mesa</p>

    <div class="campo">
      <label for="nombreInput" class="sr-only">Nombre completo</label>
      <input id="nombreInput" type="text" placeholder="Tu nombre completo" autocomplete="off" aria-label="Nombre completo" />
      <ul id="sugerencias" role="listbox" aria-expanded="false"></ul>
    </div>

    <button id="confirmarBtn" type="button" disabled>Cargando lista‚Ä¶</button>
    <div id="infoSeleccion" aria-live="polite"></div>
  </div>

  <script>
    // =============================================================================
    // CONFIGURACI√ìN - Datos de Google Sheets y URL de destino
    // =============================================================================
    const CONFIG = {
      spreadsheetId: "1LKsB3nXQ8NqosmyuoiLTRxUrrQzsXAnf2hVlIxoiYQI",
      apiKey: "AIzaSyC916C1gjId46ClbCpxNaLRkPITQVKkF5E",
      backendConfirmURL: "https://alienxz77b.github.io/Invitacion/mapa.html"
    };

    // =============================================================================
    // ESTADO GLOBAL DE LA APLICACI√ìN
    // =============================================================================
    let estado = {
      invitados: [],           // Lista completa de invitados
      seleccionado: null,      // Invitado actualmente seleccionado
      sugerencias: []          // Lista de sugerencias filtradas
    };

    // =============================================================================
    // ELEMENTOS DEL DOM
    // =============================================================================
    const elementos = {
      input: document.getElementById("nombreInput"),
      sugerencias: document.getElementById("sugerencias"),
      boton: document.getElementById("confirmarBtn"),
      info: document.getElementById("infoSeleccion")
    };

    // =============================================================================
    // FUNCIONES UTILITARIAS
    // =============================================================================

    /**
     * Normaliza texto para b√∫squedas sin acentos y en min√∫sculas
     * @param {string} texto - Texto a normalizar
     * @returns {string} Texto normalizado
     */
    function normalizarTexto(texto) {
      if (!texto) return "";
      return texto
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .toLowerCase();
    }

    /**
     * Valida si hay un invitado seleccionado v√°lido
     * @returns {boolean} True si hay un invitado v√°lido seleccionado
     */
    function hayInvitadoValido() {
      return estado.seleccionado && estado.seleccionado.codigo;
    }

    // =============================================================================
    // FUNCIONES PRINCIPALES
    // =============================================================================

    /**
     * Carga la lista de invitados desde Google Sheets
     */
    async function cargarInvitados() {
      const rango = "Invitados!A2:G";
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.spreadsheetId}/values/${rango}?key=${CONFIG.apiKey}`;

      try {
        const respuesta = await fetch(url);
        if (!respuesta.ok) throw new Error(`Error HTTP: ${respuesta.status}`);

        const datos = await respuesta.json();

        if (datos.values) {
          // Mapear datos de la hoja de c√°lculo a objetos invitado
          estado.invitados = datos.values.map(fila => ({
            codigo: fila[0] || "",
            nombre: fila[1] || "",
            adultos: fila[2] || "0",
            ninos: fila[3] || "0",
            mesa: fila[5] || "Por asignar",
            confirmado: fila[6] || "No"
          }));

          // Habilitar interfaz
          elementos.boton.disabled = false;
          elementos.boton.textContent = "Buscar mesa";

          console.log(`‚úÖ ${estado.invitados.length} invitados cargados`);
        } else {
          throw new Error("No se encontraron datos en la hoja de c√°lculo");
        }
      } catch (error) {
        console.error("‚ùå Error al cargar invitados:", error);
        elementos.boton.textContent = "Error al cargar";
        alert("No se pudo cargar la lista de invitados. Intenta m√°s tarde.");
      }
    }

    /**
     * Muestra informaci√≥n del invitado seleccionado
     * @param {Object} invitado - Objeto invitado o null para ocultar
     */
    function mostrarInformacionInvitado(invitado) {
      if (!invitado) {
        elementos.info.style.display = "none";
        elementos.info.textContent = "";
        return;
      }

      elementos.info.style.display = "block";
      elementos.info.innerHTML = `
        <strong>${invitado.nombre}</strong><br>
        Mesa: ${invitado.mesa} ‚Ä¢ Adultos: ${invitado.adultos} ‚Ä¢ Ni√±os: ${invitado.ninos}
      `;
    }

    /**
     * Renderiza la lista de sugerencias basada en la b√∫squeda
     * @param {Array} listaSugerencias - Lista de invitados que coinciden
     */
    function renderizarSugerencias(listaSugerencias) {
      elementos.sugerencias.innerHTML = "";
      estado.sugerencias = listaSugerencias;

      if (listaSugerencias.length === 0) {
        elementos.sugerencias.classList.remove("mostrar");
        return;
      }

      // Si hay una sola coincidencia, seleccionarla autom√°ticamente
      if (listaSugerencias.length === 1) {
        estado.seleccionado = listaSugerencias[0];
        elementos.input.value = estado.seleccionado.nombre;
        mostrarInformacionInvitado(estado.seleccionado);
        elementos.sugerencias.classList.remove("mostrar");
        return;
      }

      // Crear elementos de lista para m√∫ltiples coincidencias
      listaSugerencias.forEach(invitado => {
        const elementoLista = document.createElement("li");
        elementoLista.role = "option";
        elementoLista.textContent = invitado.nombre;

        elementoLista.onclick = () => {
          estado.seleccionado = invitado;
          elementos.input.value = invitado.nombre;
          mostrarInformacionInvitado(invitado);
          elementos.sugerencias.classList.remove("mostrar");
        };

        elementos.sugerencias.appendChild(elementoLista);
      });

      elementos.sugerencias.classList.add("mostrar");
    }

    /**
     * Realiza la b√∫squeda de invitados y maneja la redirecci√≥n
     */
    function buscarYRedirigir() {
      // Caso 1: Ya hay un invitado seleccionado (de sugerencias o b√∫squeda previa)
      if (hayInvitadoValido()) {
        window.location.href = `${CONFIG.backendConfirmURL}?codigo=${encodeURIComponent(estado.seleccionado.codigo)}`;
        return;
      }

      // Caso 2: Buscar por texto ingresado
      const consulta = elementos.input.value.trim();

      if (!consulta) {
        alert("Por favor, escribe tu nombre para buscar tu mesa.");
        return;
      }

      const coincidencias = estado.invitados.filter(invitado =>
        normalizarTexto(invitado.nombre).includes(normalizarTexto(consulta))
      );

      if (coincidencias.length === 0) {
        alert("No se encontr√≥ ning√∫n invitado con ese nombre. Verifica la ortograf√≠a.");
        return;
      }

      // Si hay una sola coincidencia, redirigir directamente
      if (coincidencias.length === 1) {
        estado.seleccionado = coincidencias[0];
        window.location.href = `${CONFIG.backendConfirmURL}?codigo=${encodeURIComponent(estado.seleccionado.codigo)}`;
        return;
      }

      // M√∫ltiples coincidencias: mostrar sugerencias
      renderizarSugerencias(coincidencias);
    }

    /**
     * Maneja la b√∫squeda en tiempo real mientras se escribe
     */
    function manejarBusquedaEnTiempoReal() {
      const consulta = elementos.input.value.trim();
      estado.seleccionado = null;
      mostrarInformacionInvitado(null);

      if (consulta.length < 2) {
        elementos.sugerencias.classList.remove("mostrar");
        return;
      }

      const coincidencias = estado.invitados.filter(invitado =>
        normalizarTexto(invitado.nombre).includes(normalizarTexto(consulta))
      );

      renderizarSugerencias(coincidencias);
    }

    // =============================================================================
    // CONFIGURACI√ìN DE EVENTOS
    // =============================================================================

    /**
     * Configura todos los event listeners
     */
    function configurarEventos() {
      // Evento del bot√≥n principal
      elementos.boton.addEventListener("click", buscarYRedirigir);

      // Evento de tecla Enter en el input
      elementos.input.addEventListener("keydown", evento => {
        if (evento.key === "Enter") {
          evento.preventDefault();
          buscarYRedirigir();
        }
      });

      // B√∫squeda en tiempo real (solo sugerencias, sin redirecci√≥n autom√°tica)
      elementos.input.addEventListener("input", manejarBusquedaEnTiempoReal);

      // Cerrar sugerencias al hacer clic fuera
      document.addEventListener("click", evento => {
        if (!elementos.input.contains(evento.target) && !elementos.sugerencias.contains(evento.target)) {
          elementos.sugerencias.classList.remove("mostrar");
        }
      });
    }

    // =============================================================================
    // INICIALIZACI√ìN
    // =============================================================================

    /**
     * Funci√≥n principal de inicializaci√≥n
     */
    function inicializar() {
      configurarEventos();
      cargarInvitados();
    }

    // Iniciar la aplicaci√≥n cuando la p√°gina cargue
    window.addEventListener("load", inicializar);
  </script>
</body>
</html>
